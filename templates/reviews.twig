{# Template - /reviews - sprava recenzi pro recenzenta #}

{% extends 'layout.twig' %}

{% block content %}
    {% set total = articles|length %}
    {% set pending = 0 %}
    {% set accepted = 0 %}
    {% set denied = 0 %}

    {% for a in articles %}
        {% if a.status == 'prijato' %}
            {% set accepted = accepted + 1 %}
        {% elseif a.status == 'zamitnuto' %}
            {% set denied = denied + 1 %}
        {% else %}
            {% set pending = pending + 1 %}
        {% endif %}
    {% endfor %}

    <div>
        <section class="container mx-auto px-4 py-8">
            <!-- Hlavicka -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                <div>
                    <h1 class="text-3xl font-bold">Moje recenze</h1>
                    <p class="text-sm opacity-70 mt-1">Správa recenzovaných článků</p>
                </div>
            </div>

            <!-- Toast notifikace -->
            <div class="toast hidden" id="messageToast">
                <div class="alert alert-success shadow-lg">
                    <span id="messageText"></span>
                </div>
            </div>

            <!-- Tabs -->
            <div role="tablist" class="tabs tabs-boxed mb-6 bg-base-200 p-1">
                <a role="tab" class="tab tab-active" data-filter="all">
                    Všechny
                    <div class="badge badge-sm ml-2">{{ total }}</div>
                </a>
                <a role="tab" class="tab" data-filter="pending">
                    Čekající na recenzi
                    <div class="badge badge-warning badge-sm ml-2">{{ pending }}</div>
                </a>
                <a role="tab" class="tab" data-filter="accepted">
                    Přijato
                    <div class="badge badge-success badge-sm ml-2">{{ accepted }}</div>
                </a>
                <a role="tab" class="tab" data-filter="denied">
                    Zamítnuto
                    <div class="badge badge-error badge-sm ml-2">{{ denied }}</div>
                </a>
            </div>

            <!-- Seznam článků -->
            <div class="space-y-4" id="articlesContainer">
                {% for article in articles %}
                    {% set status = article.status %}
                    {% if status == 'prijato' %}
                        {% set filter_status = 'accepted' %}
                    {% elseif status == 'zamitnuto' %}
                        {% set filter_status = 'denied' %}
                    {% else %}
                        {% set filter_status = 'pending' %}
                    {% endif %}

                    <div class="card bg-base-100 shadow-xl article-card"
                         data-status="{{ status }}"
                         data-article-id="{{ article.clanek_id }}"
                         data-review-id="{{ article.recenze_id }}">
                        <div class="card-body">
                            <!-- Info -->
                            <div class="flex-1">
                                <h2 class="card-title">{{ article.nazev_clanku }}</h2>

                                <!-- Status -->
                                {% if status == 'prijato' %}
                                    <div class="badge badge-success gap-1 mt-2">
                                        <i data-lucide="check" class="w-3 h-3"></i>
                                        Přijato
                                    </div>
                                {% elseif status == 'zamitnuto' %}
                                    <div class="badge badge-error gap-1 mt-2">
                                        <i data-lucide="x" class="w-3 h-3"></i>
                                        Zamítnuto
                                    </div>
                                {% else %}
                                    <div class="badge badge-warning gap-1 mt-2">
                                        <i data-lucide="clock" class="w-3 h-3"></i>
                                        Čeká na recenzi
                                    </div>
                                {% endif %}

                                <p class="text-sm opacity-80 mt-2">{{ article.abstrakt }}</p>

                                <!-- PDF Link -->
                                <div class="flex items-center gap-2 mt-3 text-sm">
                                    <span class="opacity-70">{{ article.datum|date('d.m.Y') }}</span>
                                    <i data-lucide="file-text" class="w-4 h-4"></i>
                                    <a href="{{ article.pdf_odkaz }}" target="_blank" class="link link-primary">Zobrazit
                                        PDF</a>
                                </div>
                            </div>

                            <!-- Souhrn existujici recenze -->
                            <div class="review-summary mt-4 pt-4 border-t border-base-300">
                                <h3 class="font-semibold mb-3 flex items-center gap-2">
                                    <i data-lucide="star" class="w-4 h-4"></i>
                                    Vaše hodnocení
                                </h3>

                                <div class="bg-base-200 rounded-lg p-4 space-y-3">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                        <div class="flex justify-between items-center">
                                            <span class="opacity-70">Inovace a originalita:</span>
                                            <div class="rating rating-sm">
                                                {% for i in 1..5 %}
                                                    <input type="radio" class="mask mask-star-2 bg-warning" disabled
                                                           {% if i <= article.cat1 %}checked{% endif %} />
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="opacity-70">Dopad na udržitelnost:</span>
                                            <div class="rating rating-sm">
                                                {% for i in 1..5 %}
                                                    <input type="radio" class="mask mask-star-2 bg-warning" disabled
                                                           {% if i <= article.cat2 %}checked{% endif %} />
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="opacity-70">Technická proveditelnost:</span>
                                            <div class="rating rating-sm">
                                                {% for i in 1..5 %}
                                                    <input type="radio" class="mask mask-star-2 bg-warning" disabled
                                                           {% if i <= article.cat3 %}checked{% endif %} />
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="opacity-70">Kvalita zpracování:</span>
                                            <div class="rating rating-sm">
                                                {% for i in 1..5 %}
                                                    <input type="radio" class="mask mask-star-2 bg-warning" disabled
                                                           {% if i <= article.cat4 %}checked{% endif %} />
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>

                                    {% if article.komentar %}
                                        <div class="pt-3 border-t border-base-300">
                                            <p class="text-sm"><strong>Komentář:</strong></p>
                                            <p class="text-sm opacity-70 mt-1">{{ article.komentar|raw }}</p>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- hidden data pro formular -->
                                <div class="review-data hidden"
                                     data-comment="{{ article.komentar ?? '' }}"
                                     data-cat1="{{ article.cat1 }}"
                                     data-cat2="{{ article.cat2 }}"
                                     data-cat3="{{ article.cat3 }}"
                                     data-cat4="{{ article.cat4 }}">
                                </div>
                            </div>

                            <!-- Formular recenze -->
                            <div class="review-form-container hidden mt-4 pt-4 border-t border-base-300 space-y-4">
                                <form class="reviewForm space-y-4">
                                    <input type="hidden" class="article-id" value="{{ article.clanek_id }}"/>
                                    <input type="hidden" class="review-id" value="{{ my_review.recenze_id ?? '' }}"/>

                                    <!-- Category 1 -->
                                    <div class="space-y-2">
                                        <label class="label">
                                            <span class="label-text font-medium">Inovace a originalita *</span>
                                        </label>
                                        <div class="flex gap-2 items-center">
                                            <div class="rating rating-lg gap-1">
                                                {% for i in 1..5 %}
                                                    <input type="radio" name="cat1" value="{{ i }}"
                                                           class="mask mask-star-2 bg-warning"/>
                                                {% endfor %}
                                            </div>
                                            <span class="text-sm opacity-70 cat1-value">-</span>
                                        </div>
                                    </div>

                                    <!-- Category 2 -->
                                    <div class="space-y-2">
                                        <label class="label">
                                            <span class="label-text font-medium">Dopad na udržitelnost *</span>
                                        </label>
                                        <div class="flex gap-2 items-center">
                                            <div class="rating rating-lg gap-1">
                                                {% for i in 1..5 %}
                                                    <input type="radio" name="cat2" value="{{ i }}"
                                                           class="mask mask-star-2 bg-warning"/>
                                                {% endfor %}
                                            </div>
                                            <span class="text-sm opacity-70 cat2-value">-</span>
                                        </div>
                                    </div>

                                    <!-- Category 3 -->
                                    <div class="space-y-2">
                                        <label class="label">
                                            <span class="label-text font-medium">Technická proveditelnost a metodologická kvalita *</span>
                                        </label>
                                        <div class="flex gap-2 items-center">
                                            <div class="rating rating-lg gap-1">
                                                {% for i in 1..5 %}
                                                    <input type="radio" name="cat3" value="{{ i }}"
                                                           class="mask mask-star-2 bg-warning"/>
                                                {% endfor %}
                                            </div>
                                            <span class="text-sm opacity-70 cat3-value">-</span>
                                        </div>
                                    </div>

                                    <!-- Category 4 -->
                                    <div class="space-y-2">
                                        <label class="label">
                                            <span class="label-text font-medium">Kvalita zpracování a srozumitelnost *</span>
                                        </label>
                                        <div class="flex gap-2 items-center">
                                            <div class="rating rating-lg gap-1">
                                                {% for i in 1..5 %}
                                                    <input type="radio" name="cat4" value="{{ i }}"
                                                           class="mask mask-star-2 bg-warning"/>
                                                {% endfor %}
                                            </div>
                                            <span class="text-sm opacity-70 cat4-value">-</span>
                                        </div>
                                    </div>

                                    <!-- Komentar -->
                                    <div>
                                        <label class="label" for="comment-{{ article.clanek_id }}">
                                            <span class="label-text">Komentář</span>
                                        </label>
                                        <textarea id="comment-{{ article.clanek_id }}"
                                                  class="review-comment"></textarea>
                                    </div>

                                    <div class="flex gap-2">
                                        <button type="button" class="btn btn-ghost btn-sm cancel-review-btn">Zrušit
                                        </button>
                                        <button type="submit" class="btn btn-primary btn-sm">
                                            <i data-lucide="save" class="w-4 h-4"></i>
                                            Uložit recenzi
                                        </button>
                                    </div>
                                </form>
                            </div>

                            {% if article.status != "prijato" %}
                                <!-- Upravit -->
                                <div class="card-actions mt-4">
                                    <button class="btn btn-sm btn-outline edit-review-btn"
                                            data-article-id="{{ article.clanek_id }}">
                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                        {% if my_review %}Upravit recenzi{% else %}Recenzovat{% endif %}
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- Prazdny stav -->
            <div id="emptyState" class="hidden text-center py-12">
                <i data-lucide="inbox" class="w-16 h-16 mx-auto opacity-30 mb-4"></i>
                <p class="text-lg opacity-70">Zatím nemáte žádné články k recenzi</p>
            </div>
        </section>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="/vendor/tinymce/tinymce/tinymce.min.js" referrerpolicy="origin" crossorigin="anonymous"></script>
    <script src="/templates/scripts/reviews.js"></script>
{% endblock %}
